name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '23'

    - name: Setup Kotlin
      run: |
        sudo snap install --classic kotlin
        kotlin -version

    - name: Download JUnit dependencies
      run: |
        mkdir -p lib
        wget -q https://repo1.maven.org/maven2/org/junit/jupiter/junit-jupiter/5.14.0/junit-jupiter-5.14.0.jar -O lib/junit-jupiter-5.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/jupiter/junit-jupiter-api/5.14.0/junit-jupiter-api-5.14.0.jar -O lib/junit-jupiter-api-5.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/jupiter/junit-jupiter-engine/5.14.0/junit-jupiter-engine-5.14.0.jar -O lib/junit-jupiter-engine-5.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/jupiter/junit-jupiter-params/5.14.0/junit-jupiter-params-5.14.0.jar -O lib/junit-jupiter-params-5.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/platform/junit-platform-commons/1.14.0/junit-platform-commons-1.14.0.jar -O lib/junit-platform-commons-1.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/platform/junit-platform-engine/1.14.0/junit-platform-engine-1.14.0.jar -O lib/junit-platform-engine-1.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.14.0/junit-platform-console-standalone-1.14.0.jar -O lib/junit-platform-console-standalone-1.14.0.jar
        wget -q https://repo1.maven.org/maven2/org/opentest4j/opentest4j/1.3.0/opentest4j-1.3.0.jar -O lib/opentest4j-1.3.0.jar
        wget -q https://repo1.maven.org/maven2/org/apiguardian/apiguardian-api/1.1.2/apiguardian-api-1.1.2.jar -O lib/apiguardian-api-1.1.2.jar
        wget -q https://repo1.maven.org/maven2/org/jetbrains/kotlin/kotlin-stdlib/2.1.0/kotlin-stdlib-2.1.0.jar -O lib/kotlin-stdlib-2.1.0.jar

    - name: Create output directories
      run: |
        mkdir -p out/production
        mkdir -p out/test

    - name: Compile source code
      run: |
        kotlinc -d out/production -cp . src/Solution.kt

    - name: Run main application
      run: |
        kotlin -cp out/production SolutionKt

    - name: Compile tests
      run: |
        kotlinc -d out/test -cp "out/production:lib/junit-jupiter-api-5.14.0.jar:lib/junit-platform-commons-1.14.0.jar:lib/opentest4j-1.3.0.jar:lib/apiguardian-api-1.1.2.jar" src/SolutionTest.kt

    - name: Run tests
      run: |
        java -jar lib/junit-platform-console-standalone-1.14.0.jar \
          execute \
          --class-path "out/production:out/test:lib/kotlin-stdlib-2.1.0.jar" \
          --scan-class-path out/test \
          --reports-dir=test-results | tee test-results/test-output.txt

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/

    - name: Extract test metrics
      if: always()
      run: |
        # Parse XML test results to extract metrics
        if [ -f "test-results/TEST-junit-jupiter.xml" ]; then
          TESTS=$(grep -oP 'tests="\K[0-9]+' test-results/TEST-junit-jupiter.xml | head -1)
          FAILURES=$(grep -oP 'failures="\K[0-9]+' test-results/TEST-junit-jupiter.xml | head -1)
          ERRORS=$(grep -oP 'errors="\K[0-9]+' test-results/TEST-junit-jupiter.xml | head -1)
          SKIPPED=$(grep -oP 'skipped="\K[0-9]+' test-results/TEST-junit-jupiter.xml | head -1)
          
          PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))
          
          echo "Total Tests: $TESTS"
          echo "Passed: $PASSED"
          echo "Failed: $FAILURES"
          echo "Errors: $ERRORS"
          echo "Skipped: $SKIPPED"
          
          # Create badges directory
          mkdir -p .github/badges
          
          # Determine badge color based on results
          if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
            COLOR="brightgreen"
            STATUS="passing"
          else
            COLOR="red"
            STATUS="failing"
          fi
          
          # Create badge data as JSON for shields.io endpoint style
          echo "{\"schemaVersion\": 1, \"label\": \"tests\", \"message\": \"$PASSED/$TESTS passed\", \"color\": \"$COLOR\"}" > .github/badges/tests.json
          echo "{\"schemaVersion\": 1, \"label\": \"status\", \"message\": \"$STATUS\", \"color\": \"$COLOR\"}" > .github/badges/status.json
          
          # Output for use in other steps
          echo "TESTS=$TESTS" >> $GITHUB_ENV
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILURES=$FAILURES" >> $GITHUB_ENV
          echo "ERRORS=$ERRORS" >> $GITHUB_ENV
        fi

    - name: Extract test list
      if: always()
      run: |
        chmod +x .github/scripts/extract-test-list.sh
        ./.github/scripts/extract-test-list.sh

    - name: Update README with test metrics
      if: always() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        # Only update README on main/master branch pushes
        if [ -f ".github/badges/tests.json" ] && [ -f "test-results/test-list.md" ]; then
          # Get current values
          TESTS="${TESTS:-0}"
          PASSED="${PASSED:-0}"
          FAILURES="${FAILURES:-0}"
          
          # Update or insert badges section in README
          if grep -q "<!-- TEST_METRICS_START -->" README.md; then
            # Update existing section
            BADGE_COLOR=$([ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ] && echo "brightgreen" || echo "red")
            sed -i '/<!-- TEST_METRICS_START -->/,/<!-- TEST_METRICS_END -->/c\<!-- TEST_METRICS_START -->\n![Build Status](https://github.com/${{ github.repository }}/actions/workflows/build.yml/badge.svg)\n![Tests](https://img.shields.io/badge/tests-'"$PASSED/$TESTS"'%20passed-'"$BADGE_COLOR"')\n<!-- TEST_METRICS_END -->' README.md
          else
            # Insert new section after the title
            BADGE_COLOR=$([ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ] && echo "brightgreen" || echo "red")
            sed -i '1 a\<!-- TEST_METRICS_START -->\n![Build Status](https://github.com/${{ github.repository }}/actions/workflows/build.yml/badge.svg)\n![Tests](https://img.shields.io/badge/tests-'"$PASSED/$TESTS"'%20passed-'"$BADGE_COLOR"')\n<!-- TEST_METRICS_END -->\n' README.md
          fi
          
          # Update or insert test results section in README
          if grep -q "<!-- TEST_RESULTS_START -->" README.md; then
            # Update existing section - remove old section first
            sed -i '/<!-- TEST_RESULTS_START -->/,/<!-- TEST_RESULTS_END -->/d' README.md
          fi
          
          # Insert test results section after badges
          if grep -q "<!-- TEST_METRICS_END -->" README.md; then
            # Create a temporary file with the content
            {
              sed -n '1,/<!-- TEST_METRICS_END -->/p' README.md
              echo ""
              echo "<!-- TEST_RESULTS_START -->"
              cat test-results/test-list.md
              echo "<!-- TEST_RESULTS_END -->"
              sed -n '/<!-- TEST_METRICS_END -->/,$p' README.md | tail -n +2
            } > README.md.tmp
            mv README.md.tmp README.md
          else
            # Insert at the beginning if badges section doesn't exist
            {
              sed -n '1p' README.md
              echo ""
              echo "<!-- TEST_RESULTS_START -->"
              cat test-results/test-list.md
              echo "<!-- TEST_RESULTS_END -->"
              tail -n +2 README.md
            } > README.md.tmp
            mv README.md.tmp README.md
          fi
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Commit and push if there are changes
          git add README.md .github/badges/
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“Š Atualizar mÃ©tricas de testes no README [skip ci]"
            git push
          fi
        fi

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Preparar arquivos para GitHub Pages
      run: |
        mkdir -p _site
        cp index.html _site/
        cp README.md _site/
        cp .nojekyll _site/
        
        # Se houver outros arquivos necessÃ¡rios para o Docsify, copie aqui
        if [ -d "docs" ]; then
          cp -r docs/* _site/
        fi
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
